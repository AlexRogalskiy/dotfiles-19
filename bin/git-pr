#!/usr/bin/env node
const https = require('https')
const path = require('path')
const {homedir} = require('os')
const {execSync} = require('child_process')
const {readFileSync} = require('fs')

const get = (path, options) => new Promise((resolve, reject) => {
  const opts = {
    protocol: 'https:',
    host: 'api.github.com',
    path,
  ...options}
  const req = https.get(opts, res => {
    let body = ''
    res.on('data', chunk => {
      body += chunk
    })
    res.on('end', () => {
      res.statusCode === 200
        ? resolve(JSON.parse(body))
        : reject(Error(`request failed with status code ${res.statusCode}: ${body}`))
    })
  })
  req.on('error', reject)
})

const open = (url) => {
  process.platform === 'darwin'
    ? execSync(`open "${url}"`)
    : execSync(`xdg-open "${url}"`)
}

const owner = 'ridewithgps'
const repo = 'rwgps-ui'
const branch = 'mega_excellent'
const token = readFileSync(path.join(homedir(), '.gh_token'), {encoding: 'utf8'}).trim()

const query = `head:"${branch}" repo:"${owner}/${repo}"`

const search = `/search/issues?q=${encodeURIComponent(query)}`
const headers = {
  'Authorization': `token ${token}`,
  'User-Agent': '@qrohlf'
}

const main = async () => {
  try {
    const {items} = await get(search, {headers})
    if (items.length === 0) {
      console.log('no PR found')
    }
    const url = items[0].html_url
    console.log('ðŸŒŽ ' + url + '\n')
    open(url)
  } catch (e) {
    console.log(e)
  }
}

main()
